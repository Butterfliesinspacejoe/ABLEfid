<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ABLEfid — Dashboard</title>
  <link rel="stylesheet" href="assets/ablefid.css" />
  <!-- Magic UMD -->
  <script src="https://cdn.jsdelivr.net/npm/magic-sdk@latest/dist/magic.js"></script>
  <script>
    window.MAGIC_PUBLISHABLE_KEY = "pk_live_8A7A254AFE5756EC";
    window.MAGIC_NET = { rpcUrl: "https://testnet.evm.nodes.onflow.org", chainId: 545 };
  </script>
</head>
<body>
  <div class="container">
    <header aria-label="Site header">
      <a href="index.html" class="brand" aria-label="ABLEfid home">
        <img src="assets/Logo.png" alt="ABLEfid logo" class="logo-img" />
        <span class="brand-name">ABLEfid</span>
      </a>
      <nav class="nav-actions" aria-label="Primary">
        <button class="btn btn-outline" id="logoutBtn">Logout</button>
      </nav>
    </header>

    <section class="hero" style="padding-top:32px">
      <h1 class="title">Welcome to your Dashboard</h1>
      <p class="subtitle">Below is your session info. Use this page to wire wallet actions next.</p>

      <article class="card" id="userCard">
        <h3>Session</h3>
        <pre id="userJson" style="white-space:pre-wrap;margin:0;color:#0f172a;background:#f8fafc;padding:12px;border-radius:10px;border:1px solid #e2e8f0;"></pre>
      </article>

      <div class="cta" style="margin-top:16px">
        <a class="btn btn-primary" href="#" id="actionSend">Send USDC (placeholder)</a>
        <a class="btn btn-outline" href="#" id="actionReceive">Show Address (placeholder)</a>
      </div>

      <!-- WalletConnect controls -->
      <div class="card" style="margin-top:16px">
        <h3>Connect External Wallet</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px">
          <button id="btnConnectWC" class="btn primary">Connect Wallet</button>
          <button id="btnDisconnectWC" class="btn btn-outline">Disconnect</button>
        </div>
        <p id="wcStatus" class="subtitle" style="margin-top:8px;color:#475569">Not connected</p>
      </div>
    </section>

    <!-- Wallet mapping panels -->
    <section class="card">
      <h3>Lookup Wallet Mapping</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="uuidInput" placeholder="user-uuid-123" />
        <button id="getWalletBtn" class="btn primary">Get Wallet</button>
      </div>
      <div id="walletResult" class="subtitle" style="margin-top:8px"></div>
    </section>

    <section class="card">
      <h3>Admin: Set Mapping</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
        <input id="uuidSet" placeholder="user-uuid-123" />
        <input id="addrSet" placeholder="0xAbc123..." />
        <button id="btnSet" class="btn">Set Wallet</button>
      </div>
      <div id="outSet" class="subtitle"></div>
      <small>Note: this sends a transaction; you’ll need test gas on Flow EVM Testnet.</small>
    </section>

    <footer>
      <span id="year"></span> © ABLEfid. All rights reserved.
    </footer>
  </div>

  <script>
    // Footer year
    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();
  
    // One Magic init (UMD) using the same config as login
    const magic = new window.Magic(window.MAGIC_PUBLISHABLE_KEY, { network: window.MAGIC_NET });
  
    (async () => {
      try {
        // Source of truth = Magic session
        const ok = await magic.user.isLoggedIn();
        if (!ok) {
          // no session → go to login ONCE
          window.location.href = "login.html";
          return;
        }
  
        // We’re logged in. If you want user info, use a safe fallback.
        // Some builds may not expose getMetadata(), so avoid it here.
        const userEl = document.getElementById("userJson");
        if (userEl) userEl.textContent = "Authenticated via Magic ✅";
  
        // Optional convenience markers (do AFTER confirmed session)
        localStorage.setItem("ablefid_session", "true");
  
      } catch (e) {
        console.warn("Magic check failed", e);
        window.location.href = "login.html";
      }
    })();
  
    // Logout handler (only on click)
    document.getElementById('logoutBtn')?.addEventListener('click', async ()=>{
      try { await magic.user.logout(); } catch(e) {}
      localStorage.removeItem('ablefid_session');
      localStorage.removeItem('ablefid_user');
      window.location.href = 'index.html';
    });
  </script>  

  <!-- Contract ABI + dashboard logic -->
  <script type="module" src="assets/src/db_abi.js"></script>
  <script type="module" src="assets/src/dashboard_evm_flow.js"></script>

  <!-- WalletConnect / Web3Modal + ethers -->
  <script src="https://unpkg.com/@web3modal/wallet@4"></script>
  <script src="https://unpkg.com/@web3modal/ethers@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
  <script type="module" src="assets/src/walletconnect_flow_evm.js"></script>
</body>
</html>
