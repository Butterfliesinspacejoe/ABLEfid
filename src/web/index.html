<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ABLEfid — Accessible Financial Trust</title>
  <meta name="description" content="ABLEfid helps fiduciaries and beneficiaries manage stablecoin funds simply and securely." />
  <link rel="stylesheet" href="assets/ablefid.css">
</head>

<body>
  <div class="container">
    <header aria-label="Site header">
      <a href="index.html" class="brand" aria-label="ABLEfid home">
        <span class="logo" aria-hidden="true"></span>
        <span class="brand-name">ABLEfid</span>
      </a>
      <nav class="nav-actions" aria-label="Primary">
        <a class="btn btn-outline" href="#learn" id="learnLink">Learn More</a>
        <a class="btn btn-primary" href="login.html" id="loginLink">Login</a>
      </nav>
    </header>

    <section class="hero">
      <h1 class="title">Accessible fiduciary finance with <span class="accent">stablecoins</span>.</h1>
      <p class="subtitle">Send, receive, and track funds for ABLE accounts with a simple web experience—and programmable compliance in the background.</p>
      <div class="cta">
        <a class="btn btn-primary" href="#get-started" id="getStartedBtn">Get Started</a>
        <a class="btn btn-outline" href="#demo" id="watchDemoBtn">Watch Demo</a>
      </div>

      <div class="features" id="learn">
        <article class="card">
          <h3>For Beneficiaries</h3>
          <p>View balances, receive allowances, and spend with optional fiduciary approval.</p>
        </article>
        <article class="card">
          <h3>For Fiduciaries</h3>
          <p>Send funds, set rules, and export reports for SSA/Medicaid compliance.</p>
        </article>
        <article class="card">
          <h3>Stable & Transparent</h3>
          <p>Hold funds in USD‑pegged stablecoins; every transaction is tracked on‑chain.</p>
        </article>
        <article class="card">
          <h3>Web2‑Simple UX</h3>
          <p>Email‑style login flow with a clean, accessible interface—no crypto jargon.</p>
        </article>
      </div>
    </section>

    <a class="btn" href="/demos/flow/login.html">Flow Testnet Login</a>

    <h1>Test the connection to the smart contract!</h1>
    <input type="text" placeholder="Enter a UUID to get a wallet address!" id="userID">
    <button id="connectBtn">Connect</button>

    <h1>Create an account instead!</h1>
    <input type="text" placeholder="Enter the uuid" id="createUser">
    <button id="createButton">Connect</button>



    <h1>Wallet result:</h1>
    <div id="wallet_result"></div>

    <h1>Purchase stable coolcoin</h1>

    <button id="connect">Connect MetaMask</button>
    <input id="usdValue" type="number" value="1" min="1">
    <button id="purchase">Purchase</button>



    <!-- UI -->
    <h1>Redeem</h1>
    <input id="redeemValue" type="number" value="1" min="0" step="0.01" />
    <button id="redeemBtn">Redeem CoolCoin</button>
    <pre id="redeemLog"></pre>

    <footer>
      <span id="year"></span> © ABLEfid. All rights reserved.
    </footer>
  </div>



  <!--Inline script to just load smart contract addr-->
  <script type="module">



    //------------START--------------------------------------


    const userToAdd = localStorage.getItem("username")
    if(!userToAdd){
      window.location.href = "/login.html"
    }


    async function get_wallet() {
      console.log("Connecting to Flow testnet…");
      const userElement = document.getElementById('userID')
      const user = userElement.value
      
      console.log(`Testing user ${user}`)
      const contract = new ethers.Contract(contractAddress, abi, provider);
      const result = await contract.getWallet(user);
      console.log("Wallet address:", result);
      localStorage.setItem("userAddress", result);
      return result
    }


    get_wallet().then(() => {
        console.log("Wallet lookup finished!");
      }).catch(err => {
        console.error("Error:", err);
      });

      const NULL_ADDRESS = "0x0000000000000000000000000000000000000000";
      const addr = localStorage.getItem("userAddress")
      if(addr.toLowerCase() === NULL_ADDRESS){
        //Prompt to create, refresh the page

      }
    

    //3. Show options

    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js";
    const rpcUrl = "https://testnet.evm.nodes.onflow.org";
    const provider = new ethers.JsonRpcProvider(rpcUrl);

    const contractAddress = "0xE0668BAc6c1E123CbC72e6096C267Eabb117A79A"; //.env?
    const abi = [
      "function getWallet(string) view returns (address)"
    ];
  

    //Create Account
    async function create_account(){

      //Setup info
      const RPC_URL = "https://testnet.evm.nodes.onflow.org";
      const PRIVATE_KEY = "0xcaac23ba960094ee4958423a549ea904331167423f8091fa244a603a58a24704"; //.env, Our dev wallet to pay for this transaction
      const CONTRACT_ADDRESS = "0xE0668BAc6c1E123CbC72e6096C267Eabb117A79A"; //.env
      
      //Get the user input
      const userToAddElement = document.getElementById('createUser')
      

      //Get the contract abi
      const artifact = await fetch("/assets/FlowDB.json").then(res => res.json());
      const abi = artifact.abi;
      
      //Get the provider (testnet)
      const provider = new ethers.JsonRpcProvider(RPC_URL);
      const wallet = new ethers.Wallet(PRIVATE_KEY, provider);
      const contract = new ethers.Contract(CONTRACT_ADDRESS, abi, wallet);

      //Create a random wallet
      const clientWallet = ethers.Wallet.createRandom().connect(provider);
      console.log(`This is your address, save it!!! ${clientWallet.address}`)
      console.log(`This is your private key, save it!!! ${clientWallet.privateKey}`)
  
      
      const addressToAdd = clientWallet.address
      const tx = await contract.setWallet(userToAdd, addressToAdd, { //Those two arguments should be variables
        gasLimit: 500_000,
      });

      const receipt = await tx.wait();
      console.log("Sucessful! This is the block no. - ", receipt.blockNumber);

  }
  
  document.getElementById("createButton").addEventListener("click", create_account);




//make sure metamask on right network

const FLOW_CHAIN_ID = "0x221"; // 545 decimal

async function switchToFlowTestnet() {
  try {
    // Try switching first
    await window.ethereum.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: FLOW_CHAIN_ID }],
    });
  } catch (switchError) {
    // If the chain isn’t added, add it then switch
    if (switchError.code === 4902) {
      await window.ethereum.request({
        method: "wallet_addEthereumChain",
        params: [{
          chainId: FLOW_CHAIN_ID,
          chainName: "Flow EVM Testnet",
          nativeCurrency: {
            name: "Flow",
            symbol: "FLOW",
            decimals: 18,
          },
          rpcUrls: ["https://testnet.evm.nodes.onflow.org"],
          blockExplorerUrls: ["https://evm-testnet.flowscan.io"],
        }],
      });
    } else {
      throw switchError;
    }
  }
}

//--------------------------------------------------PAY "MONEY" FOR STABLE COIN COOLCOIN--------------------------//
    
      let contract, signer;


      const CONTRACT_ADDRESS = "0xe34A005185EF623244e58C8E172B8130b7EdF394";
      const artifactCoin = await fetch("/assets/coolCoin.json").then(res => res.json());
      const coinABI = artifactCoin.abi;
      

      // Connect MetaMask
      document.getElementById("connect").onclick = async () => {
        if (!window.ethereum) return alert("Install MetaMask!");
        await switchToFlowTestnet();
        const provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, coinABI, signer);
        console.log("Connected as:", await signer.getAddress());
      };

      // Mint CoolCoin
      document.getElementById("purchase").onclick = async () => {
        const usd = document.getElementById("usdValue").value;
        if (!usd || usd <= 0) return alert("Enter amount > 0");

        try {
          const value = ethers.parseEther(usd.toString());
          const tx = await contract.mint({ value });
          console.log("Mint tx:", tx.hash);
          await tx.wait();
          console.log(`Minted ${usd} coolCoin`);
        } catch (err) {
          console.error(err);
          console.log("Error:", err.message);
        }
      };
          


//-----------------------------------REDEEM COOL COIN FOR FLOW COINS---------------------------------------------//

async function redeem() {
    try {
      if (!contract) return alert("Connect MetaMask first.");

      const userAddr = await signer.getAddress();
      const decimals = await contract.decimals();
      const want = document.getElementById("redeemValue").value;
      if (!want || Number(want) <= 0) return alert("Enter an amount > 0");

      const amt = ethers.parseUnits(want.toString(), decimals);

      
      const bal = await contract.balanceOf(userAddr);
      if (bal < amt) return alert("Not enough COOL to redeem that amount.");

      const tx = await contract.redeem(amt);
      console.log("Redeem tx:", tx.hash);
      await tx.wait();
      console.log(`✅ Redeemed ${want} COOL for Flow`);

      // (Optional) show fresh balances
      const newBal = await contract.balanceOf(userAddr);
      console.log("Your COOL balance:", ethers.formatUnits(newBal, decimals));
    } catch (err) {
      console.error(err);
      // Common revert reasons:
      // - "Not enough tokens" (you don't hold that much)
      // - "Not enough Flow in reserve" (contract lacks native coins to pay you back)
      log("❌ Error:", err.message ?? String(err));
    }
  }

  document.getElementById("redeemBtn").addEventListener("click", redeem);
</script>
  
</body>
</html>
